default:
    image: 'thlmylab/swakkd:stable'

variables:
    VERSION_NUMBER: 1.0.0-alpha.$CI_PIPELINE_ID

stages:
- prepare
- build
- deploy

secrets:
    stage: prepare
    script:
    - kubectl delete secret gitlab-registry-$CI_PROJECT_ID || true
    - "kubectl create secret docker-registry gitlab-registry-$CI_PROJECT_ID \
                    --docker-server=$CI_REGISTRY \
                    --docker-username=image-registry \ 
                    --docker-password=$CI_REGISTRY_TOKEN"
    needs: []

build-frontend-image:
    stage: build
    image: docker:stable
    services: ["docker:dind"]
    script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY_IMAGE/babelfish-frontend:VERSION_NUMBER frontend/
    - docker tag $CI_REGISTRY_IMAGE/babelfish-frontend:latest
    - docker push $CI_REGISTRY_IMAGE/babelfish-frontend:VERSION_NUMBER
    - docker push $CI_REGISTRY_IMAGE/babelfish-frontend:latest
    needs: []

build-backend-image:
    stage: build
    image: docker:stable
    services: ["docker:dind"]
    script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $CI_REGISTRY_IMAGE/babelfish-backend:VERSION_NUMBER backend/
    - docker tag $CI_REGISTRY_IMAGE/babelfish-backend:latest
    - docker push $CI_REGISTRY_IMAGE/babelfish-backend:VERSION_NUMBER
    - docker push $CI_REGISTRY_IMAGE/babelfish-backend:latest
    needs: []

nginx:
    stage: deploy
    script:
    - cd deploy
    - kubectl apply -f nginx-dep.yaml
    - kubectl apply -f nginx-svc.yaml

hello:
    stage: deploy
    script:
    - cd deploy
    - mo hello-dep.yaml | kubectl delete -f - || true
    - mo hello-dep.yaml | kubectl apply -f -
    - mo hello-svc.yaml | kubectl apply -f -
